<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Expense</title>
  <script> if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark'); </script>
  <link rel="stylesheet" href="/static/style.css?v={{ range(100000, 999999) | random }}" />
  <link rel="manifest" href="/static/manifest.json" />
  <meta name="theme-color" content="#111827">
</head>

<body>
  <form method="get" action="/"><button type="submit" id="home-btn" class="theme-toggle"> 🏠 </button></form>
  <button id="theme-toggle" class="theme-toggle"> {% if theme == "dark" %}☀️{% else %}🌙{% endif %} </button>
  <button id="install-btn" class="btn install" style="display: none;">📲 インストール</button>
  <div class="container">
    <h1>📝 Expense </h1>

    {% if selected_type and input_date and input_amount %}
    <div class="success">
      ✅ 家計簿への登録が完了しました。
      <p><strong> {{ input_date }}, {{ selected_type }}, {{ input_memo + ", " if input_memo else "" }}¥{{ "{:,}".format(input_amount)}} </strong></p>
    </div>
    {% endif %}

    {% if delete_type and delete_date and delete_amount %}
    {% if delete_status %}
    <div class="success">
      ✅ 家計簿の削除処理が完了しました。
    {% else %}
    <div class="failed">
      🚫 家計簿の削除処理に失敗しました。
    {% endif %}
      <p><strong> {{ delete_date }}, {{ delete_type }}, {{ delete_memo + ", " if delete_memo else "" }}¥{{ "{:,}".format(delete_amount)}} </strong></p>
    </div>
    {% endif %}

    <div class="card">
      <form method="post" action="/register">
        <h3>🚀 家計簿に登録する情報を入力</h3>

        <input
          type="date"
          id="expense-date"
          name="expense_date"
          value="{{ expense_date or today }}"
          min="{{ expense_date_range[0] }}"
          max="{{ expense_date_range[1] }}"
          required
        />

        <select id="expense-type" name="expense_type">
          {% for item in items %}
          <option value="{{ item }}">
            {{ item }}
          </option>
          {% endfor %}
        </select>

        <input type="number" id="expense-amount" name="expense_amount" value=""
          placeholder="💴 金額を入力" {% if items | length and "/" in items[0] %} style="display: none;" {% else %} required
          {% endif %} />

        <input type="text" id="expense-memo" name="expense_memo" value="" placeholder="✏️ メモを入力"
          {% if items | length and "/" in items[0] %} style="display: none;" {% endif %} />

        <button type="submit" class="btn">＋ 登録</button>
      </form>
    </div>

    {% if screenshot_name %}
    <div class="card">
      <form method="post" action="/ocr">
        <h3> 📷️ 決済アプリのスクショから支払情報を取得 </h3>
        <div id="screenshot-name">
          ▶️ 対象画像 : {{ screenshot_name.split("/") | last }}
        </div>
        <img class="screenshot" alt="{{ screenshot_name.split(" /") | last }}"
          src="data:image/png;base64,{{ screenshot_base64 }}"
          onclick="this.classList.toggle('is-zoomed')"
        >
        <button type="submit" class="btn secondary" {% if disable_ocr %} disabled {% endif %}> {% if disable_ocr %} 登録済
          {% else %} 読取実行 {% endif %}</button>
      </form>
    </div>
    {% endif %}

    <div class="card">
      <h3 id="report-section">
        <span> 📊 支出レポート ({{today}}) </span>
        <span id="report-toggle"> ▼ </span>
      </h3>
      <div id="report-container">
        <div class="summary-list">
          <li> 本日の支出金額 : ¥{{ "{:,}".format(today_total) }} </li>
          <li> 今月の支出金額 : ¥{{ "{:,}".format(monthly_total) }} </li>
          <li> 前月の支出金額 : ¥{{ "{:,}".format(prev_monthly_total) }} </li>
        </div>
        {% if graph_html %}
          <div class="graph-container">
            <hr>
            {{ graph_html | safe }}
          </div>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <h3 id="table-section">
        <span> 🧾 直近の支出履歴 ({{n_records}}件) </span>
        <span id="table-toggle"> ▼ </span>
      </h3>
      <form method="post" action="/delete">
        <diV id="confirmation-overlay" class="overlay" style="display: none;">
          <div id="confirmation-dialog" class="confirm">
            🗑️ レコードを削除しますか？
            <p id="record-info"><strong></strong></p>
            <input type="hidden" name="expense_date" id="delete-record-date">
            <input type="hidden" name="expense_type" id="delete-record-type">
            <input type="hidden" name="expense_amount" id="delete-record-amount">
            <input type="hidden" name="expense_memo" id="delete-record-memo">
            <div class="confirmation-btn-container">
              <button type="button" class="btn-no"> キャンセル </button>
              <button type="submit" class="btn-yes"> 削除 </button>
            </div>
          </div>
        </div>
      </form>
      <a href="{{ gspread_url }}" class="link-spread"> 🔗 スプレッドシートを開く </a>
      <div id="records-container" class="records-container">
        <div class="search-wrapper">
          <input type="text" id="search-input" placeholder="🔍️ 支出タイプ or メモで検索" onkeyup="filterTable()" />
          <button id="clear-search" type="button">✕</button>
        </div>
        <div class="table-container">
          <table>
            <colgroup>
              <col>
              <col>
              <col>
              <col>
              <col style="width: 45px;">
            </colgroup>
            <thead>
              <tr>
                <th>日付</th>
                <th>カテゴリ</th>
                <th>金額</th>
                <th>メモ</th>
                <th>編集</th>
              </tr>
            </thead>
            <tbody>
              {% for record in records %}
              <tr>
                <td>{{ record.date }}</td>
                <td>{{ record.expense_type }}</td>
                <td>¥{{ "{:,}".format(record.expense_amount) }}</td>
                <td class="memo">{{ record.expense_memo }}</td>
                <td>
                  <span class="table-edt-btn"> 📝 </span>
                  <span class="table-del-btn"> 🗑️ </span>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div id="total-amount" style="display: none"></div>
      </div>
    </div>
  </div>
  <div id="loader" class="overlay" style="display: none;">
    <div class="spinner"></div>
  </div>
</body>
<script src="/static/main.js?v={{ range(100000, 999999) | random }}"></script>

</html>
