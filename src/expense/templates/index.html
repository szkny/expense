<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Expense</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="manifest" href="/static/manifest.json" />
  </head>
  <body>
    <button id="theme-toggle" class="theme-toggle">ğŸŒ™</button>
    <div class="container">
      <h1>ğŸ“ Expense </h1>
      <p>å®¶è¨ˆç°¿ã«ç™»éŒ²ã™ã‚‹æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>

      <div class="card">
        <form method="post" action="/register">
          <label for="expense-type">ğŸš€ æ”¯å‡ºã‚¿ã‚¤ãƒ—</label>
          <select id="expense-type" name="expense_type">
            {% for item in items %}
              <option
                value="{{ item }}"
                {% if selected_type and selected_type == item %}
                  selected
                {% endif %}
              >
                {{ item }}
              </option>
            {% endfor %}
          </select>

          <input
            type="number"
            id="expense-amount"
            name="expense_amount"
            value="{{ expense_amount or '' }}"
            placeholder="ğŸ’°ï¸ é‡‘é¡ã‚’å…¥åŠ›"
            {% if items | length and "/" in items[0] %}
              style="display: none;"
            {% else %}
              required
            {% endif %}
          />

          <input
            type="text"
            id="expense-memo"
            name="expense_memo"
            value="{{ expense_memo or '' }}"
            placeholder="âœï¸ ãƒ¡ãƒ¢ã‚’å…¥åŠ›"
            {% if items | length and "/" in items[0] %}
              style="display: none;"
            {% endif %}
          />

          <button type="submit" class="btn">ï¼‹ ç™»éŒ²</button>
        </form>
      </div>

      <div class="card">
        <form method="post" action="/ocr">
          <p>ğŸ“·ï¸ æ±ºæ¸ˆã‚¢ãƒ—ãƒªç”»é¢ã®ã‚¹ã‚¯ã‚·ãƒ§ã‹ã‚‰æ”¯æ‰•æƒ…å ±ã‚’å–å¾—</p>
          <button type="submit" class="btn secondary">OCR å®Ÿè¡Œ</button>
        </form>
      </div>

      {% if selected_type and input_amount %}
        <div class="success">
          âœ… å®¶è¨ˆç°¿ã¸ã®ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚
          <p><strong>{{ selected_type }}: {{ input_memo + ", " if input_memo else "" }}Â¥{{ "{:,}".format(input_amount) }}</strong></p>
        </div>
      {% endif %}

      <h2>
        ğŸ“Š ç›´è¿‘ã®æ”¯æ‰•å±¥æ­´ ({{ n_records }}ä»¶)
        <button id="table-toggle" class="btn table">â–¼ ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º</button>
      </h2>
      
      <div id="records-container" class="table-container">
        <table>
          <thead>
            <tr>
              <th>æ—¥ä»˜</th>
              <th>æ”¯å‡ºã‚¿ã‚¤ãƒ—</th>
              <th>é‡‘é¡</th>
              <th class="memo">ãƒ¡ãƒ¢</th>
            </tr>
          </thead>
          <tbody>
            {% for record in records %}
              <tr>
                <td>{{ record.date }}</td>
                <td>{{ record.expense_type }}</td>
                <td>Â¥{{ "{:,}".format(record.expense_amount) }}</td>
                <td class="memo">{{ record.expense_memo }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <script>
      const typeSelect = document.getElementById("expense-type");
      const amountInput = document.getElementById("expense-amount");
      const memoInput = document.getElementById("expense-memo");
      typeSelect.addEventListener("change", function () {
        if (this.value.includes("/")) {
          amountInput.style.display = "none";
          memoInput.style.display = "none";
          amountInput.required = false;
        } else {
          amountInput.style.display = "block";
          memoInput.style.display = "block";
          amountInput.required = true;
        }
      });

      // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆå‡¦ç†
      const toggleBtnTheme = document.getElementById("theme-toggle");
      const body = document.body;

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å‰å›ã®è¨­å®šã‚’åæ˜ 
      if (localStorage.getItem("theme") === "dark") {
        body.classList.add("dark");
        toggleBtnTheme.textContent = "â˜€ï¸";
      }

      toggleBtnTheme.addEventListener("click", () => {
        body.classList.toggle("dark");
        const isDark = body.classList.contains("dark");
        toggleBtnTheme.textContent = isDark ? "â˜€ï¸" : "ğŸŒ™";
        localStorage.setItem("theme", isDark ? "dark" : "light");
      });

      // ãƒ†ãƒ¼ãƒ–ãƒ«ã®æŠ˜ã‚ŠãŸãŸã¿å‡¦ç†
      const toggleBtnTable = document.getElementById("table-toggle");
      const recordsContainer = document.getElementById("records-container");
      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å‰å›ã®æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã‚’å¾©å…ƒ
      const collapsed = localStorage.getItem("recordsCollapsed") === "true";
      if (collapsed) {
        recordsContainer.style.display = "none";
        toggleBtnTable.textContent = "â–² ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’éè¡¨ç¤º";
      }
      toggleBtnTable.addEventListener("click", () => {
        const isCollapsed = recordsContainer.style.display === "none";
        if (isCollapsed) {
          recordsContainer.style.display = "block";
          toggleBtnTable.textContent = "â–¼ ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º";
          localStorage.setItem("recordsCollapsed", "false");
        } else {
          recordsContainer.style.display = "none";
          toggleBtnTable.textContent = "â–² ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’éè¡¨ç¤º";
          localStorage.setItem("recordsCollapsed", "true");
        }
      });
    </script>
  </body>
</html>
